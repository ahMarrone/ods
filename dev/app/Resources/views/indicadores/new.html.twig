{% extends 'base.html.twig' %}


{% block stylesheets %}
    {{ parent() }}

    <link href="{{ asset('css/bootstrap-datepicker3.min.css') }}" rel="stylesheet" />
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script src="{{ asset('js/underscore-min.js') }}"></script>
    <script src="{{ asset('js/backbone-min.js') }}"></script>
    <script src="{{ asset('js/bootstrap-datepicker.min.js') }}"></script>
    <script src="{{ asset('js/ThreeSelect.js') }}"></script>
    <script src="{{ asset('js/HighlightDates.js') }}"></script>
    <script src="{{ asset('js/globalutils.js') }}"></script>

{% endblock %}

{% block body %}

    <ol class="breadcrumb">
        <li><a href="{{ path('paneluser_index') }}">Panel de usuario</a></li>
        <li><a href="{{ path('admin_crud_indicadores_index') }}">Indicadores</a></li>
        <li class="active">Nuevo indicador</a></li>
    </ol>

    <div class="page-header">
          <h2>Nuevo Indicador</h2>
    </div>

    {{ form_start(form) }}

        <div>
           <div id="selects"></div>
        </div>

		
		{{ form_widget(form) }}
                    

         <div>
           <div id="highlightDatesControl"></div>
        </div>

        <hr>
        

        <input class="col-md-1 col-md-offset-2 btn btn-success option-btn" type="submit" value="Guardar" />
    {{ form_end(form) }}

<div class="row">
<a class="col-md-1 btn btn-primary option-btn" href="{{ path('admin_crud_indicadores_index') }}">Volver</a>
</div>



<script type="text/javascript">

    $(document).ready(function() {

        var api_urls = {{ api_urls|json_encode|raw}};
        var objetivos = {{ objetivos|json_encode|raw}};
        var metas = {{ metas|json_encode|raw}};

        var modelThreeSelect = null;
        var viewThreeSelect = null;

        var modelHighlightDates = null;
        var viewHighlightDates = null;

        function addThreeSelectControls(){
            modelThreeSelect = new ThreeSelectData({
                'objetivos': objetivos,
                'metas': metas
            });
            viewThreeSelect = new ThreeSelectView({el: $("#selects"), model:modelThreeSelect,
            metaChangeCallback: getNextIndicadorCode
            });
        }

        // Agrego al formulario controles para agregar fechas destacadas
        function addHiglightedDatesControls(){
            modelHighlightDates = new HighlightDates({dates:[]});
            viewHighlightDates = new HighlightDatesView({el: $("#highlightDatesControl"), model:modelHighlightDates});
        }

        function getNextIndicadorCode(){
            var idMeta = $('#three_select_meta').val();
            var url = api_urls.get_next_indicador_code;
            var data = {'meta_id':idMeta};
            appendSpinner($('#indicadores_codigo').parent().parent());
            $.ajax(url,{
                  'data': JSON.stringify(data),
                  'type': 'POST',
                  'processData': false,
                  'contentType': 'application/json',
                   success: function(data) {
                        if (data.next_indicador_code){
                            $('#indicadores_codigo').val(data.next_indicador_code);
                        }
                   },
                   error: function(data) {
                        
                  },
                  complete: function(data){
                    removeSpinner();
                  }
              });
        }

        function indicadorTypeHasChanged(newType){
            if (newType == 'entero'){
                $('.input-user-entry').each(function(index){
                    if ($(this).val()){
                      $(this).val(parseInt($(this).val()));  
                  }
                })
            }
        }

        function init(){
            addThreeSelectControls();
            addHiglightedDatesControls();
            if (!$('#indicadores_codigo').val()){
                getNextIndicadorCode();         
            }
        }

        init();

        $('input.expected-value-datepicker').datepicker({
            format: "yyyy",
            minViewMode: 2,
            autoclose: true,
        });


        $(':input[name="indicadores[tipo]"]').on('click', function(){
            indicadorTypeHasChanged(this.value);
        })

        $('.range-input-entry').on('change', function(){
            $(this).val(Math.floor($(this).val()));
        })

        
        $(".expected-value-input").change( function() {
            if ($(':input[name="indicadores[tipo]"]:checked').val() == 'entero'){
                $(this).val(parseInt($(this).val()));
            }
        })

        $('form[name="indicadores"]').submit(function() {
            // Seteo fechas destacadas en el formulario
            $('#indicadores_fechasdestacadas').val(modelHighlightDates.getFormattedDates());
        });



    });
</script>



{% endblock %}
